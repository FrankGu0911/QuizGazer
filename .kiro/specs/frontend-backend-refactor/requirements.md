# 需求文档

## 介绍

本项目旨在将现有的QuizGazer桌面应用重构为前后端分离的架构。当前应用是一个基于PySide6的单体桌面应用，具有AI问答、截图识别、知识库管理等功能。重构后将分为客户端应用和服务端API，支持用户管理、计费系统、Token鉴权等企业级功能。

## 现有功能详述

### 核心功能模块

#### 1. 智能截图识题功能
- **截图区域选择**: 用户点击截图按钮后，可以通过鼠标拖拽选择屏幕任意区域
- **多屏幕支持**: 支持多显示器环境，用户可在设置中选择截图的目标屏幕
- **图像识别**: 使用视觉语言模型(VLM)从截图中自动提取问题文本
- **问题编辑**: 如果自动识别不准确，用户可以手动编辑识别出的问题文本

#### 2. AI问答系统
- **双模型架构**: 
  - VLM模型：用于图像中的问题识别
  - LLM模型：用于文本问答
- **服务端统一管理**: AI模型配置和调用统一在服务端处理，客户端无需配置
- **直接问答**: 支持直接向AI模型发送图像获取答案，无需先提取文本
- **按次计费**: 每次AI调用（VLM/LLM）消耗1个Token，按调用次数计费

#### 3. 知识库系统
- **多模式知识库**: 支持公开、私有、收费三种知识库模式
- **文档管理**: 支持上传、存储和管理各种格式的文档
- **向量搜索**: 使用向量数据库进行文档向量化存储和相似性搜索
- **RAG问答**: 结合检索增强生成技术，基于知识库内容回答问题
- **权限控制**: 根据知识库类型和用户权限控制访问
- **收藏功能**: 用户可收藏公开知识库，在客户端选择使用
- **网页端管理**: 提供完整的网页端知识库浏览和管理界面

#### 4. 客户端技术选择与界面设计

**确定技术选择: Tauri**

使用Tauri框架重构客户端应用：
- **UI层**: React + TypeScript + Tailwind CSS (负责界面展示和用户交互)
- **系统层**: Rust + Tauri (负责截图、文件操作、API调用等系统功能)
- **架构优势**: 
  - 体积小(~15MB)，比PySide6应用小很多
  - 性能好，启动速度快
  - 现代化UI，易于维护
  - AI编程工具支持度高
- **迁移策略**: 保持原有功能不变，仅更换技术实现

**界面功能要求:**
- **浮动窗口**: 
  - 紧凑模式：默认显示为小型浮动图标，不干扰用户工作
  - 扩展模式：截图后自动展开显示问题和答案
- **窗口管理**: 
  - 支持窗口置顶功能，方便对照使用
  - 可拖拽到屏幕任意位置
  - 一键复制答案到剪贴板
- **用户系统集成**: 
  - 登录界面和用户状态显示
  - Token余额显示和使用历史
  - 知识库选择和管理功能
- **设置界面**: 提供屏幕选择、服务器连接等客户端设置

#### 5. 网页端管理界面
- **知识库浏览**: 展示公开知识库，支持搜索、分类、评分筛选
- **知识库管理**: 用户创建、编辑、删除自己的知识库
- **文档管理**: 支持拖拽上传和批量管理文档
- **定价设置**: 设置知识库的访问权限和Token售价
- **统计分析**: 显示知识库使用情况和收益统计
- **用户中心**: 个人信息管理、Token充值、使用历史等

#### 6. 服务端配置管理
- **集中配置**: 所有AI模型和服务配置统一在服务端管理
- **环境变量**: 使用环境变量管理敏感配置信息
- **动态配置**: 支持运行时配置更新，无需重启服务
- **多租户支持**: 支持不同用户组使用不同的AI服务配置

### 新架构设计目标

#### 1. 前后端分离
- **客户端**: 保留原有的桌面应用体验，专注于UI交互和本地功能
- **服务端**: 统一处理AI调用、知识库管理、用户认证等核心业务
- **网页端**: 提供知识库管理和用户中心等管理功能
- **API统一**: 所有功能通过RESTful API提供服务

#### 2. 多租户架构
- **用户隔离**: 每个用户拥有独立的数据空间和权限
- **资源管理**: 基于Token的使用量控制和计费
- **权限控制**: 细粒度的功能和数据访问权限管理
- **扩展性**: 支持大量用户并发使用

#### 3. 企业级特性
- **安全认证**: JWT Token认证和邮箱验证
- **监控告警**: 完整的系统监控和异常告警机制
- **数据备份**: 用户数据和知识库的自动备份
- **高可用**: 支持集群部署和负载均衡

#### 4. 商业化功能
- **知识库生态**: 公开/私有/收费知识库模式
- **收益分享**: 知识库创建者可获得销售收益，用户购买后可永久使用
- **Token经济**: 基于API调用次数的简单计费模式
- **扩展接口**: 预留第三方支付和其他商业功能接口

## 需求

### 需求 1 - 用户认证与管理系统

**用户故事:** 作为系统管理员，我希望有一个完整的用户管理系统，以便管理用户账户、权限和使用情况。

#### 验收标准

1. WHEN 用户首次使用系统 THEN 系统 SHALL 提供用户注册功能
2. WHEN 用户注册时 THEN 系统 SHALL 验证邮箱格式和密码强度
3. WHEN 用户注册时 THEN 系统 SHALL 发送邮箱验证码进行邮箱验证
4. WHEN 用户输入验证码时 THEN 系统 SHALL 验证验证码的有效性和时效性
5. WHEN 用户登录时 THEN 系统 SHALL 验证用户凭据并返回JWT Token
6. WHEN Token过期时 THEN 系统 SHALL 提供Token刷新机制
7. WHEN 用户忘记密码时 THEN 系统 SHALL 支持通过邮箱重置密码
8. WHEN 管理员访问用户管理界面时 THEN 系统 SHALL 显示所有用户列表、状态和使用统计
9. WHEN 管理员需要时 THEN 系统 SHALL 支持禁用/启用用户账户
10. WHEN 系统发送邮件时 THEN 应对接现有的邮件服务器进行邮件发送

### 需求 2 - 计费与Token管理系统

**用户故事:** 作为服务提供商，我希望实现基于API调用次数的Token管理系统，以便按使用次数进行计费，并为未来的充值功能预留接口。

#### 验收标准

1. WHEN 用户注册时 THEN 系统 SHALL 为用户分配初始免费Token额度
2. WHEN 用户调用VLM API时 THEN 系统 SHALL 扣除1个Token
3. WHEN 用户调用LLM API时 THEN 系统 SHALL 扣除1个Token
4. WHEN 用户Token不足时 THEN 系统 SHALL 拒绝API请求并返回余额不足错误
5. WHEN 系统设计时 THEN 应预留充值API接口以便后续接入第三方支付
6. WHEN 管理员需要时 THEN 系统 SHALL 支持手动为用户增加Token额度
7. WHEN 管理员查看时 THEN 系统 SHALL 记录所有API调用历史和Token使用记录

### 需求 3 - 服务端API架构

**用户故事:** 作为开发者，我希望有一个统一的API服务端，以便客户端通过标准接口访问所有功能。

#### 验收标准

1. WHEN 客户端发起请求时 THEN 服务端 SHALL 验证JWT Token的有效性
2. WHEN Token验证通过时 THEN 服务端 SHALL 检查用户Token余额
3. WHEN 余额充足时 THEN 服务端 SHALL 处理AI模型调用请求
4. WHEN AI调用完成时 THEN 服务端 SHALL 扣除相应Token并返回结果
5. WHEN 发生错误时 THEN 服务端 SHALL 返回标准化的错误响应
6. WHEN 系统运行时 THEN 服务端 SHALL 记录详细的API调用日志

### 需求 4 - 客户端应用重构

**用户故事:** 作为最终用户，我希望客户端应用保持原有功能的同时，增加用户登录和余额管理功能。

#### 验收标准

1. WHEN 用户启动应用时 THEN 客户端 SHALL 检查登录状态
2. WHEN 用户未登录时 THEN 客户端 SHALL 显示登录界面
3. WHEN 用户登录成功时 THEN 客户端 SHALL 保存Token并显示主界面
4. WHEN 用户使用截图功能时 THEN 客户端 SHALL 调用服务端API而非本地AI服务
5. WHEN 用户查看余额时 THEN 客户端 SHALL 显示当前Token余额和使用历史
6. WHEN Token即将过期时 THEN 客户端 SHALL 自动刷新Token

### 需求 5 - 知识库服务重构

**用户故事:** 作为用户，我希望有一个支持公开/私有/收费模式的知识库系统，并能通过网页端管理和浏览知识库。

#### 验收标准

1. WHEN 用户创建知识库时 THEN 系统 SHALL 支持设置为公开、私有或收费模式
2. WHEN 用户浏览公开知识库时 THEN 系统 SHALL 提供搜索、分类和推荐功能
3. WHEN 用户收藏公开知识库时 THEN 客户端 SHALL 能够选择使用该知识库
4. WHEN 用户购买收费知识库时 THEN 系统 SHALL 按创建者定价扣除用户Token并授予访问权限
5. WHEN 用户查询知识库时 THEN 系统 SHALL 根据权限搜索相应的文档
6. WHEN 系统处理知识库查询时 THEN 应消耗1个Token
7. WHEN 知识库创建者需要时 THEN 系统 SHALL 提供知识库销售统计和Token收益分析

### 需求 9 - 网页端知识库管理

**用户故事:** 作为用户，我希望通过网页端方便地管理、浏览和收藏知识库。

#### 验收标准

1. WHEN 用户访问网页端时 THEN 系统 SHALL 提供知识库浏览界面
2. WHEN 用户管理知识库时 THEN 系统 SHALL 支持上传、编辑、删除文档
3. WHEN 用户浏览知识库时 THEN 系统 SHALL 提供分类、标签、评分等筛选功能
4. WHEN 用户收藏知识库时 THEN 系统 SHALL 同步到用户的客户端应用
5. WHEN 知识库创建者设置时 THEN 系统 SHALL 支持设置访问权限和Token定价
6. WHEN 用户评价知识库时 THEN 系统 SHALL 记录评分和评论
7. WHEN 管理员审核时 THEN 系统 SHALL 支持知识库内容审核和违规处理

### 需求 6 - 客户端知识库集成

**用户故事:** 作为客户端用户，我希望能够选择和使用不同类型的知识库进行问答。

#### 验收标准

1. WHEN 用户登录客户端时 THEN 系统 SHALL 同步用户收藏的知识库列表
2. WHEN 用户进行问答时 THEN 客户端 SHALL 提供知识库选择功能
3. WHEN 用户选择收费知识库时 THEN 系统 SHALL 显示购买价格和已购买状态
4. WHEN 用户使用知识库问答时 THEN 系统 SHALL 调用相应的知识库API
5. WHEN 知识库不可用时 THEN 客户端 SHALL 提供降级到普通问答的选项
6. WHEN 用户管理知识库时 THEN 客户端 SHALL 提供跳转到网页端管理的功能

### 需求 7 - 数据安全与隐私

**用户故事:** 作为用户，我希望我的数据和隐私得到充分保护。

#### 验收标准

1. WHEN 用户数据传输时 THEN 系统 SHALL 使用HTTPS加密
2. WHEN 存储用户密码时 THEN 系统 SHALL 使用安全的哈希算法
3. WHEN 用户访问API时 THEN 系统 SHALL 验证用户权限
4. WHEN 用户删除账户时 THEN 系统 SHALL 完全清除用户相关数据
5. WHEN 系统记录日志时 THEN 不得包含敏感信息如密码或Token
6. WHEN 发生安全事件时 THEN 系统 SHALL 记录安全日志并通知管理员

### 需求 8 - 系统监控与管理

**用户故事:** 作为系统管理员，我希望能够监控系统运行状态和用户使用情况。

#### 验收标准

1. WHEN 管理员访问监控面板时 THEN 系统 SHALL 显示实时的API调用统计
2. WHEN 系统运行时 THEN 应记录响应时间、错误率等关键指标
3. WHEN 用户使用量异常时 THEN 系统 SHALL 发送告警通知
4. WHEN 管理员需要时 THEN 系统 SHALL 提供用户使用报告导出功能
5. WHEN 系统资源不足时 THEN 应自动限制新的API请求
6. WHEN 需要维护时 THEN 系统 SHALL 支持优雅关闭和重启

### 需求 9 - 部署与扩展性

**用户故事:** 作为运维人员，我希望系统易于部署和扩展。

#### 验收标准

1. WHEN 部署系统时 THEN 应支持Docker容器化部署
2. WHEN 用户量增长时 THEN 系统 SHALL 支持水平扩展
3. WHEN 配置变更时 THEN 系统 SHALL 支持热更新配置
4. WHEN 数据库需要扩展时 THEN 系统 SHALL 支持数据库集群
5. WHEN 系统升级时 THEN 应支持零停机升级
6. WHEN 需要负载均衡时 THEN 系统 SHALL 支持多实例部署